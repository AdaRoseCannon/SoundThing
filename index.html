<!DOCTYPE html>
<html>
<head>
	<title>Test</title>
	<style>
	    html, body {
	        margin:0;
	        padding:0;
	        width:100%;
	        height:100%;
	    }
	
	    canvas{
	        width:100%;
	        height:100%;
    	    left:0;
    	    top:0;
	    }
	</style>
	<script type="text/javascript" charset="utf-8" async defer>
		var audioContext;
		var analyser;
		var ctx;
		var maxBins = 1024;
		var binCount;
		var step;
		var binCount;
		var WIDTH;
		var HEIGHT;
		var mediaStreamSource;
		var requestAnimFrame = (function () {
			return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || function (callback) {
				window.setTimeout(callback, 1000 / 60);
			};
		})();
		window.addEventListener('load', init, false);
		function init() {
			// success callback when requesting audio input stream
			function gotStream(stream) {
			    window.AudioContext = window.AudioContext || window.webkitAudioContext;
			    var audioContext = new AudioContext();
 
			    // Create an AudioNode from the stream.
			    mediaStreamSource = audioContext.createMediaStreamSource( stream );
			    analyser = audioContext.createAnalyser();
			    mediaStreamSource.connect( analyser );
			    // Connect it to the destination to hear yourself (or any other node for processing!)
				var canvas = document.createElement('canvas');
				binCount = Math.min(analyser.frequencyBinCount, maxBins);
				step = parseInt(analyser.frequencyBinCount/binCount, 10);
				WIDTH  = binCount;
				HEIGHT = WIDTH * document.documentElement.clientHeight / document.documentElement.clientWidth;
				canvas.width = WIDTH;
				canvas.height = HEIGHT;
				canvas.style.zIndex   = -1;
				canvas.style.position = "absolute";
				canvas.style.border   = "1px solid";
				document.body.appendChild(canvas);
				ctx = canvas.getContext("2d");
				mainLoop();
			}
			navigator.getUserMedia = navigator.getUserMedia || navigator.mozGetUserMedia || navigator.webkitGetUserMedia;
			navigator.getUserMedia( {audio:true}, gotStream, function (err) {
				console.log(err);
			} );
 
		}
 
		function getData () {
		    var freqData = new Float32Array(analyser.frequencyBinCount);
			var min = analyser.minDecibels;
		    var max = analyser.maxDecibels;
			analyser.getFloatFrequencyData(freqData);
			var out = [];
			for(var i=1;i<freqData.length;i+=step){	
				out.push(HEIGHT-HEIGHT*(freqData[i]-min)/(max-min));
			}
			return out;
		}
 
		function draw(data) {
			ctx.clearRect(0,0,WIDTH,HEIGHT)
			ctx.beginPath();
			ctx.moveTo(0, data[0]);
			for(var i=1;i<data.length;i++){
				ctx.lineTo(i,data[i]);
			}
			ctx.stroke();
		}
		
		function mainLoop() {
			var data;

			function dataLoop() {
				requestAnimationFrame(function () {
					data = getData();
					dataLoop();
				});
			}

			function drawLoop() {
				setTimeout(function () {
					requestAnimationFrame(function () {
						draw(data);
						drawLoop();
					})
				}, 100);
			}

			drawLoop();
			dataLoop();
		}

	</script>
</head>
<body>
 
</body>
</html>
